{
  "name": "02. Site Hardening Playbook: Complete Optimization Strategy",
  "description": "Comprehensive playbook covering liveness endpoints, timeout handling, async rendering, header cleanup, loader caching, and stability improvements for production deco.cx sites.",
  "content": "## Site hardening playbook (async rendering, header cleanup, stability)\n\nThis guide summarizes concrete fixes for optimizing deco.cx sites with performance and stability improvements.\n\n### 0) Symptoms this resolves\n- Kubernetes \"Liveness probe failed\" caused by heavy SSR on \"/\".\n- Slow PLP (product list) navigations due to expensive loaders and blocking sections.\n- \"Async Rendering not implemented\" warnings for sections.\n- Bloated header block with thousands of explicit paths and malformed data (numeric keys).\n- Legacy \"deco-hub\" app showing up unexpectedly.\n\n---\n\n### 1) Add a true liveness endpoint\nFile: `routes/livez.ts`\n- Return a tiny \"ok\" with no caching. Point K8s livenessProbe to `/livez`.\n\n```ts\nexport const handler = { GET() { return new Response(\"ok\", { headers: { \"cache-control\": \"no-store\" } }); } };\n```\n\nWhy: Prevent probes from hitting the homepage SSR path.\n\n---\n\n### 2) Guard network handlers with timeouts\nFiles:\n- `routes/proxy.ts`\n- `routes/api/[...catchall].tsx`\n\nWhat: Wrap upstream `fetch` with `AbortController` (8–10s). Always clear timers.\n\nWhy: Avoid hanging handlers that make instances look unhealthy.\n\n---\n\n### 3) Async Rendering best practices\nAdd a `LoadingFallback` export to heavy sections so they can render lazily without warnings:\n- `sections/HeroSectionCarousel.tsx` (skeleton)\n- `sections/BannerCarousel.tsx` (skeleton)\n- `sections/Banner.tsx` (skeleton)\n- `sections/ProductShelf.tsx` (skeleton grid)\n- `sections/PromoCountDown.tsx` (null fallback to avoid visual shift)\n- `sections/BlueTagVisit.tsx` (null fallback)\n\nRules of thumb:\n- Above-the-fold: small skeletons or null if it would shift layout (e.g., above header).\n- Below-the-fold: feel free to use skeletons.\n\n---\n\n### 4) Make homepage SSR lighter\nScripts (run from repo root with Deno):\n- Wrap heavy, safe sections in Lazy:\n  ```bash\n  deno run --allow-read --allow-write scripts/wrap-home-lazy.ts\n  ```\n- Unwrap Lazy for sections that don't support async (e.g., `$live/sections/PageInclude.tsx`):\n  ```bash\n  deno run --allow-read --allow-write scripts/unlazy-unsupported.ts\n  ```\n\nWhy: Split critical SSR and remove \"Async not implemented\" warnings.\n\n---\n\n### 5) Header cleanup and normalization\n\nProblem: The header was a LivePage with:\n- Malformed data (numeric keys per character).\n- Massive `transparentPaths` array with thousands of entries.\n- Referenced via `$live/sections/PageInclude.tsx` across many pages.\n\nSolution:\n1) Clean the legacy header page block:\n   ```bash\n   deno run --allow-read --allow-write scripts/clean-header-block.ts\n   ```\n   - Removes stray numeric keys next to strings (e.g., `alert`, `path`, `label`, `richtext`).\n   - Replaces `transparentPaths`/`newTransparentPaths` with compact `transparentPatterns`.\n\n2) Add pattern support in the Header loader (code change done once):\n   - `site/components/header/Header.tsx` adds a `transparentPatterns?: string[]` prop and resolves patterns via prefix matches. Prefer patterns like:\n     ```\n     [\"/collection/*\", \"/clothing\", \"/shoes\", \"/accessories\", \"/\"]\n     ```\n\n3) Convert the header into a standalone, reusable section block:\n   ```bash\n   # Extract section-level variants into a new block\n   deno run --allow-read --allow-write scripts/generate-header-global.ts\n   # Result: .deco/blocks/header-global.json (multivariate section)\n   ```\n\n4) Replace PageInclude usages with the new block:\n   - For home only:\n     ```bash\n     deno run --allow-read --allow-write scripts/replace-header-pageinclude-in-home.ts\n     ```\n   - Sweep all blocks:\n     ```bash\n     deno run --allow-read --allow-write scripts/replace-header-pageinclude-all.ts\n     ```\n\n5) Keep the original JSON as backup (now cleaned) but stop referencing it.\n\nWhy: The header becomes a normal section block with variants; smaller JSON; no PageInclude overhead; simpler mental model.\n\n---\n\n### 6) Remove legacy \"deco-hub\" app\nActions:\n- Delete `apps/decohub.ts`.\n- Remove `.deco/blocks/*` that resolve to `decohub/*` or `site/apps/decohub.ts` (e.g., `analytics-v0.json`).\n- Keep current analytics via `site/apps/deco/analytics.ts` blocks.\n\nWhy: Prevents old app installers from re-adding deprecated apps on boot.\n\n---\n\n### 7) Loader caching\nPrefer platform-aware fetch with proxy cache for public, cacheable loaders:\n- Example changed:\n  - `packs/wordpress/loaders/postList.ts` → `fetchAPI(url, { withProxyCache: true })`\n- Keep private/user-specific loaders (e.g., cashback by user) uncached.\n\nWhy: Reduce origin latency and stabilize SSR.\n\n---\n\n### 8) Optional improvements\n- Consider migrating from Twind SSR to Tailwind (plugin) to remove per-request CSS generation on large pages.\n- Consolidate redirects in a single CSV/block rather than hundreds of block files.\n\n---\n\n### 9) Post-change checks\n- Visit `/livez` to confirm liveness route is active.\n- Confirm home no longer logs \"Async not implemented\" warnings.\n- Verify header renders from `header-global` and patterns work (transparent + letter color).\n- Navigate PLPs; confirm response times improve and no long server-side stalls.\n- Confirm no \"deco-hub\" appears in installed apps list on boot.\n\n---\n\n### 10) Script catalog (idempotent)\n- `scripts/wrap-home-lazy.ts` — wrap homepage sections in Lazy.\n- `scripts/unlazy-unsupported.ts` — unwrap Lazy for unsupported sections (e.g., PageInclude).\n- `scripts/clean-header-block.ts` — strip numeric keys and compress transparent config.\n- `scripts/generate-header-global.ts` — generate section-level multivariate header block.\n- `scripts/replace-header-pageinclude-in-home.ts` — replace header PageInclude on the homepage.\n- `scripts/replace-header-pageinclude-all.ts` — sweep/replace header PageInclude across all blocks.\n\nAll scripts are safe to re-run; they only write when changes are detected.\n\n---\n\n### 11) Footer: remove PageInclude and centralize\nProblem:\n- Pages referenced a footer LivePage via `$live/sections/PageInclude.tsx`, adding extra resolver hops on every route.\n\nSolution:\n- Create a simple section block for the footer:\n  - `.deco/blocks/global-footer.json` → `site/sections/Footer.tsx` props only (no LivePage).\n- Sweep all blocks to replace the PageInclude with `global-footer`:\n  ```bash\n  deno run --allow-read --allow-write scripts/replace-footer-pageinclude-all.ts\n  ```\nResult:\n- Fewer block resolutions per route and simpler block editing.\n\n---\n\n### 12) PDP: group Advanced Details and dedupe product loader\nSymptoms:\n- PDP had many repeated `site/sections/ProductAdvancedDetails.tsx` sections (often Lazy‑wrapped), each resolving the same PDP loader again during SSR and per lazy render.\n\nFixes:\n1) Group the repeated sections into a single logical section:\n   - New section: `sections/ProductAdvancedDetailsGroup.tsx` that renders N advanced detail blocks from a single PDP page payload.\n   - Script to transform PDP JSON (idempotent):\n     ```bash\n     deno run --allow-read --allow-write scripts/group-pdp-advanced-details.ts\n     ```\n   - The script collapses multiple AdvancedDetails (including Lazy‑wrapped) into:\n     ```json\n     { \"__resolveType\": \"website/sections/Rendering/Lazy.tsx\",\n       \"section\": {\n         \"__resolveType\": \"site/sections/ProductAdvancedDetailsGroup.tsx\",\n         \"page\": { \"__resolveType\": \"Product Details Page@data\" },\n         \"items\": [ ... ]\n       } }\n     ```\n2) Ensure the group does not refetch PDP:\n   - Use cached `@data` key in the group's `page` (see above).\n   - As a fallback within the same request, the main PDP section exposes the page on the request context:\n     - `components/product/ProductDetails.tsx` loader sets `ctx.__pdpPage = page`.\n     - `ProductAdvancedDetailsGroup.loader` can consume `ctx.__pdpPage` if provided.\n\nVerifying:\n- In server logs for PDP, expect one MISS for `Product Details Page@data` (load‑data) and only HITs during lazy renders. You should not see a second MISS for the product details page.\n\n---\n\n### 13) Header transparency patterns on localhost\nUpdate the new header block (`header-global.json`) to use prefix‑globs so transparency applies to sub‑paths:\n```json\n{\n  \"transparentPatterns\": [\n    \"/collection/*\",\n    \"/clothing*\",\n    \"/shoes*\",\n    \"/accessories*\",\n    \"/\"\n  ]\n}\n```\nWhy: `/clothing-mens` did not match a bare `/clothing`.\n\n---\n\n### 14) Favicon: avoid Live resolution on /favicon.ico\nAdd a direct route that serves the static icon and bypasses Live:\nFile: `routes/favicon.ico.ts`\n```ts\nexport const handler = {\n  async GET() {\n    const fileUrl = new URL(\"../static/favicon-32x32.png\", import.meta.url);\n    const bytes = await Deno.readFile(fileUrl);\n    return new Response(bytes, {\n      status: 200,\n      headers: {\n        \"content-type\": \"image/png\",\n        \"cache-control\": \"public, max-age=86400, immutable\",\n      },\n    });\n  },\n};\n```\nWhy: prevents favicon from going through block resolution and extra loaders.\n\n\n"
}