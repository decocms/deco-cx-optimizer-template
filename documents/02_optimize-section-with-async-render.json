{
  "name": "04. Async Render: Code-Level Optimization with useSection + HTMX",
  "description": "Advanced techniques for optimizing section rendering using useSection hook and HTMX for device-specific and user-interaction-based lazy loading.",
  "content": "## Async Render of Section via Code (`deco` + `htmx`)\n\nYou can ask the server to render parts of a component using `useSection` (from JSR package \"@deco/deco/hooks\". Github link https://github.com/deco-cx/deco/blob/main/hooks/mod.ts) and `htmx`.\n\n### When to use?\n\nUse it to load components that vary based on the device (mobile or desktop) or when parts of the elements are visually rendered after user interaction. Instead of using tailwind classes like `hidden lg:block` to render on desktop or `lg:hidden` to hide on desktop and render on other devices.\n\n### Step-by-step implementation:\n\n1. Use `useSection()` to generate the `hx-get` URL.\n2. Add or reuse a component prop that identifies which parts of the component you want to render. Example: `variant: \"desktop\" | \"mobile\"`\n\n#### Example 1:\nA Header component that has a side drawer with links displayed for mobile devices, and for desktop displays a menu with hover that shows the links in a list.\n\nBefore optimization:\n\n```tsx\ninterface Props {/* props declaration */}\n\nfunction Header({ /*props here*/ links, images, }) {\n\n  return <header>\n\t<nav class=\"hidden lg:block ...\">\n\t\t{/* Mobile menu button */}\n\t\t<div class=\"lg:hidden\">\n\t\t\t<input name=\"open\" type=\"checkbox\" class=\"peer sr-only\"/>\n\t\t\t<div class=\"peer:checked:block hidden\">\n\t\t\t\t<Drawer .../>\n\t\t\t</div>\n\t\t</div>\n\n\t\t<div data-search>\n\t\t  <input .... />\n\t\t  <div data-search-result-slot />\n\t\t</div>\n\n\t\t<ul class=\"hidden lg:block\">\n\t\t  {links.map(link => (\n\t\t     // Hidden rendered links, can be optimized.\n\t\t\t<ul class=\"peer\">{link.name}</div>\n\t\t\t<div class=\"absolute hidden peer:hover:block\">\n\t\t\t\t{link.sublinks.map(/* ...  */)}\n\t\t\t</div>\n\t\t  ))}\n\t\t</ul>\n\t</nav>\n\n  </header>\n}\n```\n\nSuggested component optimization using async render via HTMX + useSection:\n\n```tsx\nimport {type AppContext} from \"site/apps/site.ts\"\nexport const loader = (props: Props, _req: Request, ctx: AppContext) => {\n\treturn {\n\t\t...props,\n\t\tisMobile: ctx.device === \"mobile\"\n\t}\n}\n\ninterface Props {/* props declaration */\n  /** @ignore not edited by CMS */\n  isMobile: boolean;\n\n  /** @ignore not edited by CMS */\n  renderDrawer: boolean;\n}\n\nfunction Header({ /*props here*/ links, images, isMobile, renderDrawer }) {\n\tif (renderDrawer) {\n\t// no need for hx-get trigger as it already has the drawer\n\treturn (<div id=\"drawer-wrapper\">\n\t\t<input id=\"open\" name=\"open\" type=\"checkbox\" class=\"peer sr-only\" />\n\t\t<label for=\"open\"><Icon /></label>\n\t\t<div class=\"peer:checked:block hidden\">\n\t\t\t\t<Drawer .../>\n\t\t\t</div>\n\t\t</div>)\n\t}\n\n  return <header>\n\t<nav class=\"hidden lg:block ...\">\n\t\t{/* Mobile menu button */}\n\t\t{isMobile && (<div id=\"drawer-wrapper\">\n\t\t\t<input id=\"open\" name=\"open\" type=\"checkbox\" class=\"peer sr-only\" \n\t\t\t\thx-get={useSection({\n\t\t\t\t// other props are retrieved on the server\n\t\t\t\t\tprops: {\n\t\t\t\t\t\trenderDrawer: true\n\t\t\t\t\t}\n\t\t\t\t})}\n\t\t\t\thx-trigger=\"change\"\n\t\t\t\thx-swap=\"#drawer-wrapper\"\n\t\t\t/>\n\t\t\t<label for=\"open\"><Icon /></label>\n\t\t</div>)}\n\n\t\t<div data-search>\n\t\t  <input .... />\n\t\t  <div data-search-result-slot />\n\t\t</div>\n\n\n\t\t{/* Desktop menu */}\n\t\t{!isMobile && (<ul>\n\t\t  {links.map(link => (\n\t\t\t<ul class=\"peer\">{link.name}</div>\n\t\t\t<div class=\"absolute hidden peer:hover:block\">\n\t\t\t\t{link.sublinks.map(/* ...  */)}\n\t\t\t</div>\n\t\t  ))}\n\t\t</ul>)}\n\t</nav>\n\n  </header>\n}\n```\n\n\n#### Example 2:\nComponent has a button that displays a table with a lot of data.\n\nBefore optimization:\n\n```tsx\ninterface Props {\n  data: Data[]\n}\n\nfunction TogglableTable({data}) {\n\treturn <div>\n\t\t<input type=\"checkbox\" class=\"sr-only peer\" id=\"opener-table\" />\n\t\t<label for=\"opener-table\" class=\"... classes to be like a button\"><Icon /></label>\n\t\t{/* Table that is visible when the user clicks the button */}\n\t\t<DataTable data={data} class=\"peer:checked:block hidden\" />\n\t</div>\n}\n```\n\n\nSuggested component optimization using async render via HTMX + useSection:\n\n```tsx\ninterface Props {\n  data: Data[];\n  variant: \"render-table\"\n}\n\nfunction TogglableTable({data, variant}) {\n\tif (variant === \"render-table\") {\n\t\treturn (<div>\n\t\t<input type=\"checkbox\" class=\"sr-only peer\" id=\"opener-table\" />\n\t\t<label for=\"opener-table\" class=\"... classes to be like a button\"><Icon /></label>\n\t\t{/* Table that is visible when the user clicks the button */}\n\t\t<DataTable data={data} class=\"peer:checked:block hidden\" />\n\t</div>)\n\t}\n\t\n\n\treturn (<div>\n\t\t<input type=\"checkbox\" class=\"sr-only peer\" id=\"opener-table\" />\n\t\t<label for=\"opener-table\" class=\"... classes to be like a button\"><Icon /></label>\n\t\t{/* Table that is visible when the user clicks the button */}\n\t\t<DataTable data={data} class=\"peer:checked:block hidden\" />\n\t</div>)\n}\n```\n\n"
}